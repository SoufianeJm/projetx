{% extends "billing/base.html" %}
{% load crispy_forms_tags %}

{% block title %}Facturation SLR{% endblock %}
{% block page_title %}Facturation SLR{% endblock %}

{% block content %}
<div class="facturation-wrapper">
    <div class="facturation-card">
        <form method="post" enctype="multipart/form-data" id="slrUploadForm">
            {% csrf_token %}
            <div class="custom-file-group">
                <label for="id_mafe_report_file" class="custom-label">DTT IMT France MAFE Report (xlsx)</label>
                <div class="custom-file-input-wrapper">
                    <input type="file" name="mafe_report_file" id="id_mafe_report_file" accept=".xlsx" class="custom-file-input" onchange="handleFileChange(this, 'mafe')">
                    <div class="file-preview" id="mafe-preview" style="display:none;"></div>
                </div>
            </div>
            <div class="custom-file-group">
                <label for="id_heures_ibm_file" class="custom-label">Heures IBM (xlsx)</label>
                <div class="custom-file-input-wrapper">
                    <input type="file" name="heures_ibm_file" id="id_heures_ibm_file" accept=".xlsx" class="custom-file-input" onchange="handleFileChange(this, 'heures')">
                    <div class="file-preview" id="heures-preview" style="display:none;"></div>
                </div>
            </div>
            <div class="accepted-types">Accepted files: <b>XLSX</b></div>
            <button type="button" class="btn btn-primary mt-3" id="generateReportBtn">
                <i class="fas fa-file-excel me-2"></i>Generate and Download Report
            </button>
        </form>
        {% if processing_logs %}
        <div class="mt-4 card">
            <div class="card-header">
                Processing Logs
            </div>
            <ul class="list-group list-group-flush" id="processing-log-list">
                {% for log_entry in processing_logs %}
                    <li class="list-group-item {% if 'ERROR:' in log_entry %}list-group-item-danger{% elif 'WARNING:' in log_entry %}list-group-item-warning{% else %}list-group-item-light{% endif %}">
                        {{ log_entry|safe }}
                    </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
</div>

<!-- Bootstrap 5 Modal for Mission Selection -->
<div class="modal fade" id="missionSelectModal" tabindex="-1" aria-labelledby="missionSelectModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="missionSelectModalLabel">Select Missions for Adjustment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">Select the missions below that should have their hours and costs adjusted. Others will be reported with their original values.</p>
        <div class="table-responsive">
          <table class="table table-striped table-hover" id="mission-select-table">
            <thead>
              <tr>
                <th>Select</th>
                <th>OTP L2</th>
                <th>Libell√© de Projet</th>
                <th>Belgian Name</th>
                <th>Type de Code</th>
              </tr>
            </thead>
            <tbody>
              {% for mission in missions %}
              <tr>
                <td>
                  <input type="checkbox" class="form-check-input mission-checkbox" value="{{ mission.otp_l2 }}">
                </td>
                <td>{{ mission.otp_l2 }}</td>
                <td>{{ mission.belgian_name }}</td>
                <td>{{ mission.libelle_de_projet }}</td>
                <td>{{ mission.get_code_type_display }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="proceedWithCalculationsBtn">Proceed and Generate Report</button>
      </div>
    </div>
  </div>
</div>

<style>
    .facturation-wrapper {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 60vh;
        padding: 32px 0;
    }
    .facturation-card {
        background: #fff;
        border-radius: 14px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        padding: 36px 32px 32px 32px;
        max-width: 420px;
        width: 100%;
        margin: 0 auto;
    }
    .facturation-form {
        display: flex;
        flex-direction: column;
        gap: 22px;
    }
    .custom-file-group {
        margin-bottom: 0;
    }
    .custom-label {
        font-weight: 600;
        color: var(--secondary-color);
        margin-bottom: 6px;
        display: block;
    }
    .custom-file-input-wrapper {
        position: relative;
    }
    .custom-file-input {
        display: none;
    }
    .custom-file-input + .file-preview {
        margin-top: 8px;
    }
    .custom-file-input-wrapper::before {
        content: 'Select file...';
        display: inline-block;
        background: #f5f5f5;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 10px 16px;
        color: #666;
        font-size: 1em;
        cursor: pointer;
        transition: border 0.2s;
    }
    .custom-file-input:focus + .file-preview,
    .custom-file-input-wrapper:focus-within::before {
        border-color: var(--primary-color);
    }
    .file-preview {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #f5f5f5;
        border-radius: 6px;
        padding: 8px 12px;
        margin-top: 6px;
        font-size: 0.97em;
        color: #333;
        border: 1px solid #e0e0e0;
    }
    .file-preview .file-icon {
        color: var(--primary-color);
        font-size: 1.2em;
    }
    .file-preview .file-remove {
        background: none;
        border: none;
        color: #e74c3c;
        font-size: 1.1em;
        cursor: pointer;
        margin-left: 8px;
        transition: color 0.2s;
    }
    .file-preview .file-remove:hover {
        color: #c0392b;
    }
    .accepted-types {
        color: #888;
        font-size: 0.95em;
        margin-bottom: 8px;
        margin-top: -10px;
    }
    .btn-facturation, .btn.btn-primary.mt-3 {
        background: var(--primary-color);
        color: #fff;
        border: none;
        border-radius: 7px;
        padding: 12px 0;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        margin-top: 8px;
        transition: background 0.2s;
        box-shadow: 0 2px 8px rgba(134,188,36,0.10);
    }
    .btn-facturation:hover, .btn.btn-primary.mt-3:hover {
        background: #6d9a1d;
    }
    .log-table-sample table {
        font-size: 0.8rem;
        margin-top: 5px !important;
        margin-bottom: 0 !important;
        width: auto !important;
        max-width: 100%;
        overflow-x: auto;
    }
    .log-table-sample th, .log-table-sample td {
        padding: 2px 4px !important;
    }
    .list-group-item div.log-table-sample {
        max-width: 100%;
        overflow-x: auto;
    }
    /* Modal Styles */
    .modal-lg {
        max-width: 900px;
    }
    .table-responsive {
        max-height: 60vh;
        overflow-y: auto;
    }
    .form-check {
        padding-left: 0;
    }
    .form-check-input {
        margin-left: 0;
    }
</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
function handleFileChange(input, type) {
    const preview = document.getElementById(type + '-preview');
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const size = (file.size / 1024).toFixed(2) + ' KB';
        preview.innerHTML = `<span class='file-icon'><i class='fas fa-file-excel'></i></span> ${file.name} <span style='color:#888;font-size:0.95em;'>${size}</span> <button type='button' class='file-remove' onclick='removeFile("${input.id}", "${type}-preview")'><i class='fas fa-times'></i></button>`;
        preview.style.display = 'flex';
    } else {
        preview.innerHTML = '';
        preview.style.display = 'none';
    }
}

function removeFile(inputId, previewId) {
    const input = document.getElementById(inputId);
    input.value = '';
    const preview = document.getElementById(previewId);
    preview.innerHTML = '';
    preview.style.display = 'none';
}

// Custom file input click
Array.from(document.getElementsByClassName('custom-file-input-wrapper')).forEach(function(wrapper) {
    wrapper.addEventListener('click', function(e) {
        if (e.target.className.indexOf('file-remove') === -1) {
            const input = wrapper.querySelector('input[type="file"]');
            input.click();
        }
    });
});

// Mission Selection Modal Handling
document.addEventListener('DOMContentLoaded', function() {
    const generateReportBtn = document.getElementById('generateReportBtn');
    const slrUploadForm = document.getElementById('slrUploadForm');
    const missionSelectModal = new bootstrap.Modal(document.getElementById('missionSelectModal'));
    const proceedBtn = document.getElementById('proceedWithCalculationsBtn');

    generateReportBtn.addEventListener('click', function(event) {
        event.preventDefault();
        // Validate files
        const mafeFile = slrUploadForm.querySelector('input[name="mafe_report_file"]').files.length;
        const heuresFile = slrUploadForm.querySelector('input[name="heures_ibm_file"]').files.length;
        if (!mafeFile || !heuresFile) {
            alert('Please select both MAFE report and Heures IBM files.');
            return;
        }
        missionSelectModal.show();
    });

    proceedBtn.addEventListener('click', function() {
        // Remove any existing hidden inputs
        slrUploadForm.querySelectorAll('input[type="hidden"][name="selected_otp_l2_codes"]').forEach(input => input.remove());
        // Add hidden inputs for selected missions
        document.querySelectorAll('.mission-checkbox:checked').forEach(checkbox => {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'selected_otp_l2_codes';
            hiddenInput.value = checkbox.value;
            slrUploadForm.appendChild(hiddenInput);
        });
        missionSelectModal.hide();
        slrUploadForm.submit();
    });
});
</script>
{% endblock %} 