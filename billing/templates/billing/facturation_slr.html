{% extends "billing/base.html" %}
{% load crispy_forms_tags %}

{% block title %}Facturation SLR{% endblock %}
{% block page_title %}Facturation SLR{% endblock %}

{% block content %}
<div class="facturation-wrapper">
    <div class="facturation-card">
        <form method="post" enctype="multipart/form-data" id="slrUploadForm">
            {% csrf_token %}
            <div class="custom-file-group">
                <label for="id_mafe_report_file" class="custom-label">DTT IMT France MAFE Report (xlsx)</label>
                <div class="custom-file-input-wrapper">
                    <input type="file" name="mafe_report_file" id="id_mafe_report_file" accept=".xlsx" class="custom-file-input" onchange="handleFileChange(this, 'mafe')">
                    <div class="file-preview" id="mafe-preview" style="display:none;"></div>
                </div>
            </div>
            <div class="custom-file-group">
                <label for="id_heures_ibm_file" class="custom-label">Heures IBM (xlsx)</label>
                <div class="custom-file-input-wrapper">
                    <input type="file" name="heures_ibm_file" id="id_heures_ibm_file" accept=".xlsx" class="custom-file-input" onchange="handleFileChange(this, 'heures')">
                    <div class="file-preview" id="heures-preview" style="display:none;"></div>
                </div>
            </div>
            <div class="accepted-types">Accepted files: <b>XLSX</b></div>
            <button type="button" class="btn btn-primary mt-3" id="generateReportBtn">
                <i class="fas fa-file-excel me-2"></i>Generate and Download Report
            </button>
        </form>
        {% if processing_logs %}
        <div class="mt-4 card">
            <div class="card-header">
                Processing Logs
            </div>
            <ul class="list-group list-group-flush" id="processing-log-list">
                {% for log_entry in processing_logs %}
                    <li class="list-group-item {% if 'ERROR:' in log_entry %}list-group-item-danger{% elif 'WARNING:' in log_entry %}list-group-item-warning{% else %}list-group-item-light{% endif %}">
                        {{ log_entry|safe }}
                    </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
</div>

<!-- Pure CSS/JS Modal for Mission Selection -->
<div id="missionSelectModal" class="custom-modal">
  <div class="custom-modal-content">
    <span class="custom-modal-close" id="closeMissionModal">&times;</span>
    <h3>Select Missions for Adjustment</h3>
    <p>Select the missions below that should have their hours and costs adjusted. Others will be reported with their original values.</p>
    <div class="table-responsive">
      <table class="table" id="mission-select-table">
        <thead>
          <tr>
            <th>Select</th>
            <th>Libellé de Projet</th>
          </tr>
        </thead>
        <tbody>
          <!-- Will be populated by JS -->
        </tbody>
      </table>
    </div>
    <div style="text-align:right; margin-top: 1em;">
      <button type="button" id="closeMissionModalBtn" class="modal-btn">Cancel</button>
      <button type="button" id="proceedWithCalculationsBtn" class="modal-btn modal-btn-primary">Proceed and Generate Report</button>
    </div>
  </div>
</div>

<style>
    .facturation-wrapper {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 60vh;
        padding: 32px 0;
    }
    .facturation-card {
        background: #fff;
        border-radius: 14px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        padding: 36px 32px 32px 32px;
        max-width: 420px;
        width: 100%;
        margin: 0 auto;
    }
    .facturation-form {
        display: flex;
        flex-direction: column;
        gap: 22px;
    }
    .custom-file-group {
        margin-bottom: 0;
    }
    .custom-label {
        font-weight: 600;
        color: var(--secondary-color);
        margin-bottom: 6px;
        display: block;
    }
    .custom-file-input-wrapper {
        position: relative;
    }
    .custom-file-input {
        display: none;
    }
    .custom-file-input + .file-preview {
        margin-top: 8px;
    }
    .custom-file-input-wrapper::before {
        content: 'Select file...';
        display: inline-block;
        background: #f5f5f5;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 10px 16px;
        color: #666;
        font-size: 1em;
        cursor: pointer;
        transition: border 0.2s;
    }
    .custom-file-input:focus + .file-preview,
    .custom-file-input-wrapper:focus-within::before {
        border-color: var(--primary-color);
    }
    .file-preview {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #f5f5f5;
        border-radius: 6px;
        padding: 8px 12px;
        margin-top: 6px;
        font-size: 0.97em;
        color: #333;
        border: 1px solid #e0e0e0;
    }
    .file-preview .file-icon {
        color: var(--primary-color);
        font-size: 1.2em;
    }
    .file-preview .file-remove {
        background: none;
        border: none;
        color: #e74c3c;
        font-size: 1.1em;
        cursor: pointer;
        margin-left: 8px;
        transition: color 0.2s;
    }
    .file-preview .file-remove:hover {
        color: #c0392b;
    }
    .accepted-types {
        color: #888;
        font-size: 0.95em;
        margin-bottom: 8px;
        margin-top: -10px;
    }
    .btn-facturation, .btn.btn-primary.mt-3 {
        background: var(--primary-color);
        color: #fff;
        border: none;
        border-radius: 7px;
        padding: 12px 0;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        margin-top: 8px;
        transition: background 0.2s;
        box-shadow: 0 2px 8px rgba(134,188,36,0.10);
    }
    .btn-facturation:hover, .btn.btn-primary.mt-3:hover {
        background: #6d9a1d;
    }
    .log-table-sample table {
        font-size: 0.8rem;
        margin-top: 5px !important;
        margin-bottom: 0 !important;
        width: auto !important;
        max-width: 100%;
        overflow-x: auto;
    }
    .log-table-sample th, .log-table-sample td {
        padding: 2px 4px !important;
    }
    .list-group-item div.log-table-sample {
        max-width: 100%;
        overflow-x: auto;
    }
    /* Modal Styles */
    .custom-modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0; top: 0; width: 100vw; height: 100vh;
        overflow: auto;
        background: rgba(0,0,0,0.5);
        justify-content: center; align-items: center;
    }
    .custom-modal-content {
        background: #fff;
        margin: 5% auto;
        padding: 30px 24px 18px 24px;
        border-radius: 10px;
        width: 90%;
        max-width: 900px;
        position: relative;
        box-shadow: 0 8px 32px rgba(0,0,0,0.18);
        animation: modalIn 0.2s;
    }
    @keyframes modalIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .custom-modal-close {
        position: absolute; right: 18px; top: 12px; font-size: 2em; color: #888; cursor: pointer;
    }
    .custom-modal-close:hover { color: #333; }
    .modal-btn {
        padding: 8px 18px; border: none; border-radius: 5px; background: #eee; color: #333; margin-left: 8px; cursor: pointer;
    }
    .modal-btn-primary { background: #6d9a1d; color: #fff; }
    .modal-btn-primary:hover { background: #4e6e13; }
    .table-responsive { max-height: 50vh; overflow-y: auto; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { border: 1px solid #ddd; padding: 6px 10px; }
    .table th { background: #f5f5f5; }
</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<!-- SheetJS for reading Excel files in browser -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
function handleFileChange(input, type) {
    const preview = document.getElementById(type + '-preview');
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const size = (file.size / 1024).toFixed(2) + ' KB';
        preview.innerHTML = `<span class='file-icon'><i class='fas fa-file-excel'></i></span> ${file.name} <span style='color:#888;font-size:0.95em;'>${size}</span> <button type='button' class='file-remove' onclick='removeFile("${input.id}", "${type}-preview")'><i class='fas fa-times'></i></button>`;
        preview.style.display = 'flex';
    } else {
        preview.innerHTML = '';
        preview.style.display = 'none';
    }
}

function removeFile(inputId, previewId) {
    const input = document.getElementById(inputId);
    input.value = '';
    const preview = document.getElementById(previewId);
    preview.innerHTML = '';
    preview.style.display = 'none';
}

// Custom file input click
Array.from(document.getElementsByClassName('custom-file-input-wrapper')).forEach(function(wrapper) {
    wrapper.addEventListener('click', function(e) {
        if (e.target.className.indexOf('file-remove') === -1) {
            const input = wrapper.querySelector('input[type="file"]');
            input.click();
        }
    });
});

// Mission Selection Modal Handling
document.addEventListener('DOMContentLoaded', function() {
    const generateReportBtn = document.getElementById('generateReportBtn');
    const slrUploadForm = document.getElementById('slrUploadForm');
    const modal = document.getElementById('missionSelectModal');
    const closeModalX = document.getElementById('closeMissionModal');
    const closeModalBtn = document.getElementById('closeMissionModalBtn');
    const proceedBtn = document.getElementById('proceedWithCalculationsBtn');
    const missionTableBody = document.querySelector('#mission-select-table tbody');
    // All missions from backend for JS filtering
    const allMissions = JSON.parse('{{ missions_json|escapejs }}');

    // Show modal with filtered missions
    function showMissionModal(filteredOtps) {
        // Filter missions to only those in filteredOtps
        const filteredMissions = allMissions.filter(m => filteredOtps.includes(m.otp_l2));
        // Get unique Libellé de Projet values
        const uniqueLibelles = Array.from(new Set(filteredMissions.map(m => m.libelle_de_projet)));
        // Populate table
        missionTableBody.innerHTML = '';
        if (uniqueLibelles.length === 0) {
            missionTableBody.innerHTML = '<tr><td colspan="2">No missions found in the Heures IBM file.</td></tr>';
        } else {
            uniqueLibelles.forEach(libelle => {
                const row = document.createElement('tr');
                row.innerHTML = `
                  <td><input type="checkbox" class="mission-checkbox" value="${libelle}"></td>
                  <td>${libelle}</td>
                `;
                missionTableBody.appendChild(row);
            });
        }
        modal.style.display = 'flex';
    }

    // Read OTP L2 codes from the selected Heures IBM file using SheetJS
    function extractOtpsFromHeuresFile(file, callback) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet, {defval: '', raw: false});
            // Find the column named 'OTP L2' (case-insensitive)
            const otpCol = Object.keys(json[0] || {}).find(col => col.trim().toLowerCase() === 'otp l2');
            if (!otpCol) {
                alert('Could not find "OTP L2" column in the Heures IBM file.');
                return callback([]);
            }
            const otps = Array.from(new Set(json.map(row => row[otpCol]).filter(Boolean)));
            callback(otps);
        };
        reader.readAsArrayBuffer(file);
    }

    // Show modal after reading file and extracting OTPs
    generateReportBtn.addEventListener('click', function(event) {
        event.preventDefault();
        const mafeFile = slrUploadForm.querySelector('input[name="mafe_report_file"]').files.length;
        const heuresInput = slrUploadForm.querySelector('input[name="heures_ibm_file"]');
        const heuresFile = heuresInput.files[0];
        if (!mafeFile || !heuresFile) {
            alert('Please select both MAFE report and Heures IBM files.');
            return;
        }
        extractOtpsFromHeuresFile(heuresFile, function(filteredOtps) {
            showMissionModal(filteredOtps);
        });
    });

    // Hide modal
    function closeModal() { modal.style.display = 'none'; }
    closeModalX.onclick = closeModal;
    closeModalBtn.onclick = closeModal;
    window.onclick = function(event) {
        if (event.target === modal) closeModal();
    };

    // Proceed and submit
    proceedBtn.addEventListener('click', function() {
        // Remove any existing hidden inputs
        slrUploadForm.querySelectorAll('input[type="hidden"][name="selected_otp_l2_codes"]').forEach(input => input.remove());
        // Add hidden inputs for selected libelles
        document.querySelectorAll('.mission-checkbox:checked').forEach(checkbox => {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'selected_libelle_projet';
            hiddenInput.value = checkbox.value;
            slrUploadForm.appendChild(hiddenInput);
        });
        closeModal();
        slrUploadForm.submit();
    });
});
</script>
{% endblock %} 